# Make sure that QtWebKit's CMake files can be found

SET(QT_WEBKIT_DIR ${CMAKE_SOURCE_DIR}/src/3rdparty/QtWebKit)

LIST(APPEND CMAKE_PREFIX_PATH ${QT_WEBKIT_DIR}/cmake/${PLATFORM_DIR}/Qt5WebKit)
LIST(APPEND CMAKE_PREFIX_PATH ${QT_WEBKIT_DIR}/cmake/${PLATFORM_DIR}/Qt5WebKitWidgets)

# Make sure that our copy of the QtWebKit libraries, if they exist, have the
# expected SHA-1 values

SET(QT_WEBKIT_BINARIES_DIR ${QT_WEBKIT_DIR}/bin)
SET(QT_WEBKIT_LIBRARIES_DIR ${QT_WEBKIT_DIR}/lib)

IF(WIN32)
    SET(QT_WEBKIT_LIBRARY_FILENAME ${QT_WEBKIT_BINARIES_DIR}/Qt5WebKit.dll)
    SET(QT_WEBKITWIDGETS_LIBRARY_FILENAME ${QT_WEBKIT_BINARIES_DIR}/Qt5WebKitWidgets.dll)

    SET(QT_WEBKIT_LIBRARY_SHA1_VALUE        e71c863eac0ab04ddbedbe64ab4c0cb58c47b4d8)
    SET(QT_WEBKITWIDGETS_LIBRARY_SHA1_VALUE 63aa56d0e1c1a03ff3a5688a47f4d924a6ec899e)
ELSEIF(APPLE)
    SET(QT_WEBKIT_LIBRARY_FILENAME ${QT_WEBKIT_LIBRARIES_DIR}/QtWebKit.framework/QtWebKit)
    SET(QT_WEBKITWIDGETS_LIBRARY_FILENAME ${QT_WEBKIT_LIBRARIES_DIR}/QtWebKitWidgets.framework/QtWebKitWidgets)

    SET(QT_WEBKIT_LIBRARY_SHA1_VALUE        0cb07fb27408ec93928919c90209ffa9611a3528)
    SET(QT_WEBKITWIDGETS_LIBRARY_SHA1_VALUE ec465e15efeabdb7b4deb1dc0c1dd77f4b538e59)
ELSE()
    SET(QT_WEBKIT_LIBRARY_FILENAME ${QT_WEBKIT_LIBRARIES_DIR}/libQt5WebKit.so)
    SET(QT_WEBKITWIDGETS_LIBRARY_FILENAME ${QT_WEBKIT_LIBRARIES_DIR}/libQt5WebKitWidgets.so)

    SET(QT_WEBKIT_LIBRARY_SHA1_VALUE        5c80b16c8cead4e260e67d0852614dbc49194450)
    SET(QT_WEBKITWIDGETS_LIBRARY_SHA1_VALUE 0ce4b3645b35658c76dfcfcca40d720684a2061b)
ENDIF()

IF(    EXISTS ${QT_WEBKIT_LIBRARY_FILENAME}
   AND EXISTS ${QT_WEBKITWIDGETS_LIBRARY_FILENAME})
    FILE(SHA1 ${QT_WEBKIT_LIBRARY_FILENAME} REAL_QT_WEBKIT_LIBRARY_SHA1_VALUE)
    FILE(SHA1 ${QT_WEBKITWIDGETS_LIBRARY_FILENAME} REAL_QT_WEBKITWIDGETS_LIBRARY_SHA1_VALUE)

    IF(   NOT "${REAL_QT_WEBKIT_LIBRARY_SHA1_VALUE}" STREQUAL "${QT_WEBKIT_LIBRARY_SHA1_VALUE}"
       OR NOT "${REAL_QT_WEBKITWIDGETS_LIBRARY_SHA1_VALUE}" STREQUAL "${QT_WEBKITWIDGETS_LIBRARY_SHA1_VALUE}")
        # Our copy of the QtWebKit libraries don't have the expected SHA-1
        # value, so remove the QtWebKit binaries and libraries folders

        FILE(REMOVE_RECURSE ${QT_WEBKIT_BINARIES_DIR})
        FILE(REMOVE_RECURSE ${QT_WEBKIT_LIBRARIES_DIR})
    ENDIF()
ENDIF()

# Retrieve our copy of the QtWebKit libraries from the OpenCOR website, if
# needed

IF(   NOT EXISTS ${QT_WEBKIT_LIBRARY_FILENAME}
   OR NOT EXISTS ${QT_WEBKITWIDGETS_LIBRARY_FILENAME})
    # Retrieve the compressed version of our copy of the QtWebKit libraries

    MESSAGE("Retrieving QtWebKit...")

    SET(COMPRESSED_FILENAME QtWebKit.tar.gz)
    SET(REAL_COMPRESSED_FILENAME ${QT_WEBKIT_DIR}/${COMPRESSED_FILENAME})

    FILE(DOWNLOAD "http://www.opencor.ws/binaries/src/3rdparty/QtWebKit/${PLATFORM_DIR}/${COMPRESSED_FILENAME}" ${REAL_COMPRESSED_FILENAME}
         SHOW_PROGRESS STATUS STATUS)

    # Uncompress the compressed version of our copy of the QtWebKit libraries,
    # should we have managed to retrieve it

    LIST(GET STATUS 0 STATUS_CODE)

    IF(${STATUS_CODE} EQUAL 0)
        EXECUTE_PROCESS(COMMAND ${CMAKE_COMMAND} -E tar -xzf ${REAL_COMPRESSED_FILENAME}
                        WORKING_DIRECTORY ${QT_WEBKIT_DIR} OUTPUT_QUIET)

        FILE(REMOVE ${REAL_COMPRESSED_FILENAME})
    ELSE()
        FILE(REMOVE ${REAL_COMPRESSED_FILENAME})
        # Note: this is in case we had an HTTP error of sorts, in which case we
        #       would end up with an empty file...

        MESSAGE(FATAL_ERROR "The compressed version of QtWebKit could not be retrieved...")
    ENDIF()

    # Check that our copy of the QtWebKit libraries, if we managed to retrieve
    # it, has the expected SHA-1 values

    IF(    EXISTS ${QT_WEBKIT_LIBRARY_FILENAME}
       AND EXISTS ${QT_WEBKITWIDGETS_LIBRARY_FILENAME})
        FILE(SHA1 ${QT_WEBKIT_LIBRARY_FILENAME} REAL_QT_WEBKIT_LIBRARY_SHA1_VALUE)
        FILE(SHA1 ${QT_WEBKITWIDGETS_LIBRARY_FILENAME} REAL_QT_WEBKITWIDGETS_LIBRARY_SHA1_VALUE)

        IF(   NOT "${REAL_QT_WEBKIT_LIBRARY_SHA1_VALUE}" STREQUAL "${QT_WEBKIT_LIBRARY_SHA1_VALUE}"
           OR NOT "${REAL_QT_WEBKITWIDGETS_LIBRARY_SHA1_VALUE}" STREQUAL "${QT_WEBKITWIDGETS_LIBRARY_SHA1_VALUE}")
            FILE(REMOVE_RECURSE ${QT_WEBKIT_BINARIES_DIR})
            FILE(REMOVE_RECURSE ${QT_WEBKIT_LIBRARIES_DIR})

            MESSAGE(FATAL_ERROR "QtWebKit does not have the expected SHA-1 values...")
        ENDIF()
    ELSE()
        FILE(REMOVE ${REAL_COMPRESSED_FILENAME})

        MESSAGE(FATAL_ERROR "QtWebKit could not be uncompressed...")
    ENDIF()
ENDIF()
